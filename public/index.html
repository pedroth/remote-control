<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Controller</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Eruda Debug Console -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <script type="module">
        // 1. IMPORTS
        import DomBuilder from "./domBuilder.js";

        // Socket.io (ESM version)
        import { io } from "./socket.js";

        // --- THE FIX IS HERE ---
        // We use esm.sh which wraps the library in a compatible module format
        import { Html5QrcodeScanner as qrScanner } from "./qrScanner.js";

        const socket = io();

        // --- 2. UI CONSTRUCTION (using DomBuilder) ---

        // A. Create Inputs
        const urlInput = DomBuilder.of("input")
            .attr("type", "text")
            .attr("placeholder", "https://pedroth.github.io");

        const textInput = DomBuilder.of("input")
            .attr("type", "text")
            .attr("placeholder", "Type text...");

        // B. Create the Scan Section
        const scanSection = DomBuilder.of("div")
            .attr("id", "scan-section")
            .append(
                DomBuilder.of("h2").inner("Scan Server QR"),
                // The library needs a div with an ID to render into
                DomBuilder.of("div")
                    .attr("id", "reader")
                    .style("width: 300px; margin: 0 auto;"),
                DomBuilder.of("button")
                    .style("margin-top:20px;")
                    .inner("Skip / Connected")
                    .event("click", startControl)
            );

        // C. Create the Control Section (Hidden initially)
        const controlSection = DomBuilder.of("div")
            .attr("id", "control-section")
            .addClass("hidden")
            .append(
                DomBuilder.of("div").addClass("status-bar").inner("Connected via Bun ðŸš€"),

                // URL Group
                DomBuilder.of("div").addClass("input-group").append(
                    urlInput,
                    DomBuilder.of("button").inner("Go").event("click", sendGoto)
                ),

                // Trackpad
                DomBuilder.of("div")
                    .attr("id", "trackpad")
                    .append(
                        DomBuilder
                            .of("span")
                            .inner(`Touch Area`)
                    ),
                DomBuilder.of("div").addClass("info-text").inner(`
                    1-Finger Move: Move Mouse<br>
                    1-Finger Double Tap: Left Click<br>
                    2-Finger Tap: Right Click<br>
                    2-Finger Move: Scroll
                `),

                // Keyboard Group
                DomBuilder.of("div").addClass("input-group").append(
                    textInput,
                    DomBuilder.of("button").inner("Type").event("click", sendType)
                )
            );

        // --- 3. RENDER TO DOM ---
        DomBuilder.of(document.body).append(scanSection, controlSection);


        // --- 4. LOGIC & HANDLERS ---

        // Initialize QR Scanner
        // Wait slightly for DOM to settle
        setTimeout(() => {
            try {
                let aQrScanner = new qrScanner(
                    "reader",
                    { fps: 10, qrbox: 250 }
                );
                aQrScanner.render(onScanSuccess);

                function onScanSuccess() {
                    aQrScanner.clear();
                    startControl();
                }
            } catch (err) {
                console.error("Scanner failed to init:", err);
            }
        }, 200);

        function startControl() {
            scanSection.style('display:none');
            controlSection.removeClass('hidden');
        }

        function sendGoto() {
            const val = urlInput.element.value;
            if (val) {
                socket.emit('cmd_goto', val);
                urlInput.element.value = '';
            }
        }

        function sendType() {
            const val = textInput.element.value;
            if (val) {
                socket.emit('cmd_type', val);
                textInput.element.value = '';
            }
        }

        // not used, kept for reference
        function sendClick(btn) {
            socket.emit('cmd_mouse_click', btn);
        }

        // --- 5. TRACKPAD EVENT LISTENERS ---
        const padElement = document.getElementById("trackpad");

        let lastX = 0, lastY = 0;
        let singleTapTime = 0;
        let isDragging = false;
        let isTwoFinger = false;
        let isScrolling = false;

        // Touch Start
        padElement.addEventListener("touchstart", (e) => {
            e.preventDefault();

            const touches = e.touches.length;

            // --- 1-FINGER DOUBLE TAP HOLD â†’ DRAG ---
            if (touches === 1) {
                const now = Date.now();
                if (now - singleTapTime < 300) {
                    // Double tap detected: begin drag
                    socket.emit("cmd_mouse_down", "left");
                    isDragging = true;
                }
                singleTapTime = now;
            }

            // --- 2-FINGER TAP / SCROLL DETECTION ---
            if (touches === 2) {
                isTwoFinger = true;
            }

            const t = e.touches[0];
            lastX = t.clientX;
            lastY = t.clientY;
        }, { passive: false });


        // Touch Move
        padElement.addEventListener("touchmove", (e) => {
            e.preventDefault();

            const touches = e.touches.length;

            // --- 2-FINGER SCROLL ---
            if (touches === 2) {
                const t = e.touches[0];
                const dy = t.clientY - lastY;

                eruda.get('console').log('SCROLL DETECTED', dy);
                if(dy === 0) return; // No movement

                socket.emit("cmd_scroll", { amount: dy });

                lastY = t.clientY;
                isScrolling = true;
                return;
            }

            // --- 1-FINGER MOVE ---
            if (touches === 1 && !isTwoFinger) {
                const t = e.touches[0];
                const dx = t.clientX - lastX;
                const dy = t.clientY - lastY;

                socket.emit("cmd_mouse_move", { x: dx, y: dy });

                lastX = t.clientX;
                lastY = t.clientY;
            }
        }, { passive: false });


        // Touch End
        padElement.addEventListener("touchend", (e) => {
            const touchesLeft = e.touches.length;

            // --- END DRAG ---
            if (isDragging && touchesLeft === 0) {
                socket.emit("cmd_mouse_up", "left");
                isDragging = false;
                return;
            }

            eruda.get('console').log('ATTEMPT RIGHT CLICK CHECK', isTwoFinger, touchesLeft, isScrolling);
            // --- 2-FINGER TAP â†’ RIGHT CLICK ---
            if (isTwoFinger && touchesLeft === 1 && !isScrolling) {
                eruda.get('console').log('RIGHT CLICK: two-finger tap detected');
                socket.emit("cmd_mouse_click", "right");
            }

            isTwoFinger = false;
            isScrolling = false;
        }, { passive: false });


    </script>
</body>

</html>