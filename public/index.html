<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Controller</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Eruda Debug Console -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <script type="module">
        import DomBuilder from "./domBuilder.js";

        // Use native WebSocket
        const socket = new WebSocket(
            (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host
        );

        // Helper to send events in the same format as socket.io
        function emit(event, data) {
            socket.send(JSON.stringify({ event, data }));
        }

        const urlInput = DomBuilder.of("input")
            .attr("type", "text")
            .attr("placeholder", "https://pedroth.github.io");

        const textInput = DomBuilder.of("input")
            .attr("type", "text")
            .attr("placeholder", "Type text...")
            .event("keydown", (e) => {
                console.log("!!!!", e.key);
                if (e.key === "Enter") {
                    sendKey("enter");
                } else if (e.key === "Backspace") {
                    sendKey("backspace");
                } else {
                    sendType(textInput.element.value);
                    textInput.element.value = '';
                }
            });

        function getTrackPad() {
            const trackPad = DomBuilder.of("div")
                .attr("id", "trackpad")
                .append(
                    DomBuilder
                        .of("span")
                        .inner(`
                    Touch area <br><br>
                    1-Finger Move: Move Mouse<br>
                    1-Finger Double Tap: Left Click<br>
                    2-Finger Tap: Right Click<br>
                    2-Finger Move: Scroll`)
                )

            let lastX = 0, lastY = 0;
            let singleTapTime = 0;
            let isDragging = false;
            let isTwoFinger = false;
            let isScrolling = false;

            // Touch Start
            trackPad.event("touchstart", (e) => {
                e.preventDefault();

                const touches = e.touches.length;

                // --- 1-FINGER DOUBLE TAP HOLD â†’ DRAG ---
                if (touches === 1) {
                    const now = Date.now();
                    if (now - singleTapTime < 300) {
                        // Double tap detected: begin drag
                        emit("cmd_mouse_down", "left");
                        isDragging = true;
                    }
                    singleTapTime = now;
                }

                // --- 2-FINGER TAP / SCROLL DETECTION ---
                if (touches === 2) {
                    isTwoFinger = true;
                }

                const t = e.touches[0];
                lastX = t.clientX;
                lastY = t.clientY;
            }, { passive: false });


            // Touch Move
            trackPad.event("touchmove", (e) => {
                e.preventDefault();

                const touches = e.touches.length;

                // --- 2-FINGER SCROLL ---
                if (touches === 2) {
                    const t = e.touches[0];
                    const dy = t.clientY - lastY;

                    eruda.get('console').log('SCROLL DETECTED', dy);
                    if (dy === 0) return; // No movement

                    emit("cmd_scroll", { amount: dy });

                    lastY = t.clientY;
                    isScrolling = true;
                    return;
                }

                // --- 1-FINGER MOVE ---
                if (touches === 1 && !isTwoFinger) {
                    const t = e.touches[0];
                    const dx = t.clientX - lastX;
                    const dy = t.clientY - lastY;

                    emit("cmd_mouse_move", { x: dx, y: dy });

                    lastX = t.clientX;
                    lastY = t.clientY;
                }
            }, { passive: false });


            // Touch End
            trackPad.event("touchend", (e) => {
                const touchesLeft = e.touches.length;

                // --- END DRAG ---
                if (isDragging && touchesLeft === 0) {
                    emit("cmd_mouse_up", "left");
                    isDragging = false;
                    return;
                }

                eruda.get('console').log('ATTEMPT RIGHT CLICK CHECK', isTwoFinger, touchesLeft, isScrolling);
                // --- 2-FINGER TAP â†’ RIGHT CLICK ---
                if (isTwoFinger && touchesLeft === 1 && !isScrolling) {
                    eruda.get('console').log('RIGHT CLICK: two-finger tap detected');
                    emit("cmd_mouse_click", "right");
                }

                isTwoFinger = false;
                isScrolling = false;
            }, { passive: false });
            return trackPad;
        }


        const controlSection = DomBuilder.of("div")
            .attr("id", "control-section")
            .append(
                DomBuilder
                    .of("div")
                    .addClass("status-bar")
                    .inner("Connected to remote-control ðŸš€"),
                DomBuilder.of("div")
                    .addClass("input-group")
                    .append(
                        urlInput,
                        DomBuilder.of("button")
                            .inner("Go")
                            .event("click", sendGoto)
                    ),
                getTrackPad(),
                DomBuilder.of("div")
                    .addClass("input-group")
                    .append(
                        textInput,
                    ),
            );

        DomBuilder.of(document.body).append(controlSection);

        function sendGoto() {
            const val = urlInput.element.value;
            if (val) {
                emit('cmd_goto', val);
                urlInput.element.value = '';
            }
        }

        function sendType(val) {
            emit('cmd_type', val);
        }
        
        function sendKey(val) {
            emit('cmd_key_tap', val);
        }

        // not used, kept for reference
        function sendClick(btn) {
            emit('cmd_mouse_click', btn);
        }

    </script>
</body>

</html>